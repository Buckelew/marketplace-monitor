const cloudscraper = require('cloudscraper');
const Product = require('./classes/Product')

const config = { query: 'macbook' }

const getProducts = config => new Promise((resolve, reject) => {
    cloudscraper.post({
        url: "https://offerup.com/api/graphql",
        "headers": {
            "accept": "*/*",
            "accept-language": "en-US,en;q=0.9",
            "content-type": "application/json",
            "ou-browser-user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36",
            "ou-experiment-data": "{\"datamodel_id\":\"experimentmodel24\"}",
            "sec-ch-ua": "\"Not?A_Brand\";v=\"8\", \"Chromium\";v=\"108\", \"Google Chrome\";v=\"108\"",
            "sec-ch-ua-mobile": "?0",
            "sec-ch-ua-platform": "\"Windows\"",
            "sec-fetch-dest": "empty",
            "sec-fetch-mode": "cors",
            "sec-fetch-site": "same-origin",
        },
        "referrerPolicy": "strict-origin-when-cross-origin",
        "body": `{\"operationName\":\"GetModularFeed\",\"variables\":{\"debug\":false,\"searchParams\":[{\"key\":\"q\",\"value\":\"${config.query}\"},{\"key\":\"platform\",\"value\":\"web\"},{\"key\":\"lon\",\"value\":\"-123.2807\"},{\"key\":\"lat\",\"value\":\"44.5399\"},{\"key\":\"experiment_id\",\"value\":\"experimentmodel24\"},{\"key\":\"limit\",\"value\":\"50\"},{\"key\":\"searchSessionId\",\"value\":\"3f841eca-55e9-4cc6-91b1-9a2af070e5a4\"}]},\"query\":\"query GetModularFeed($searchParams: [SearchParam], $debug: Boolean = false) {\\n  modularFeed(params: $searchParams, debug: $debug) {\\n    analyticsData {\\n      requestId\\n      searchPerformedEventUniqueId\\n      searchSessionId\\n      __typename\\n    }\\n    categoryInfo {\\n      categoryId\\n      isForcedCategory\\n      __typename\\n    }\\n    feedAdditions\\n    filters {\\n      ...modularFilterNumericRange\\n      ...modularFilterSelectionList\\n      __typename\\n    }\\n    legacyFeedOptions {\\n      ...legacyFeedOptionListSelection\\n      ...legacyFeedOptionNumericRange\\n      __typename\\n    }\\n    looseTiles {\\n      ...modularTileBanner\\n      ...modularTileBingAd\\n      ...modularTileGoogleDisplayAd\\n      ...modularTileJob\\n      ...modularTileEmptyState\\n      ...modularTileListing\\n      ...modularTileLocalDisplayAd\\n      ...modularTileSearchAlert\\n      ...modularTileSellerAd\\n      __typename\\n    }\\n    modules {\\n      ...modularGridModule\\n      __typename\\n    }\\n    pageCursor\\n    query {\\n      ...modularQueryInfo\\n      __typename\\n    }\\n    requestTimeMetadata {\\n      resolverComputationTimeSeconds\\n      serviceRequestTimeSeconds\\n      totalResolverTimeSeconds\\n      __typename\\n    }\\n    searchAlert {\\n      alertId\\n      alertStatus\\n      __typename\\n    }\\n    debugInformation @include(if: $debug) {\\n      rankedListings {\\n        listingId\\n        attributes {\\n          key\\n          value\\n          __typename\\n        }\\n        __typename\\n      }\\n      lastViewedItems {\\n        listingId\\n        attributes {\\n          key\\n          value\\n          __typename\\n        }\\n        __typename\\n      }\\n      categoryAffinities {\\n        affinity\\n        count\\n        decay\\n        affinityOwner\\n        __typename\\n      }\\n      rankingStats {\\n        key\\n        value\\n        __typename\\n      }\\n      __typename\\n    }\\n    __typename\\n  }\\n}\\n\\nfragment modularFilterNumericRange on ModularFeedNumericRangeFilter {\\n  isExpandedHighlight\\n  lowerBound {\\n    ...modularFilterNumericRangeBound\\n    __typename\\n  }\\n  shortcutLabel\\n  shortcutRank\\n  subTitle\\n  targetName\\n  title\\n  type\\n  upperBound {\\n    ...modularFilterNumericRangeBound\\n    __typename\\n  }\\n  __typename\\n}\\n\\nfragment modularFilterNumericRangeBound on ModularFeedNumericRangeFilterNumericRangeBound {\\n  label\\n  limit\\n  placeholderText\\n  targetName\\n  value\\n  __typename\\n}\\n\\nfragment modularFilterSelectionList on ModularFeedSelectionListFilter {\\n  targetName\\n  title\\n  subTitle\\n  shortcutLabel\\n  shortcutRank\\n  type\\n  isExpandedHighlight\\n  options {\\n    ...modularFilterSelectionListOption\\n    __typename\\n  }\\n  __typename\\n}\\n\\nfragment modularFilterSelectionListOption on ModularFeedSelectionListFilterOption {\\n  isDefault\\n  isSelected\\n  label\\n  subLabel\\n  value\\n  __typename\\n}\\n\\nfragment legacyFeedOptionListSelection on FeedOptionListSelection {\\n  label\\n  labelShort\\n  name\\n  options {\\n    default\\n    label\\n    labelShort\\n    selected\\n    subLabel\\n    value\\n    __typename\\n  }\\n  position\\n  queryParam\\n  type\\n  __typename\\n}\\n\\nfragment legacyFeedOptionNumericRange on FeedOptionNumericRange {\\n  label\\n  labelShort\\n  leftQueryParam\\n  lowerBound\\n  name\\n  options {\\n    currentValue\\n    label\\n    textHint\\n    __typename\\n  }\\n  position\\n  rightQueryParam\\n  type\\n  units\\n  upperBound\\n  __typename\\n}\\n\\nfragment modularTileBanner on ModularFeedTileBanner {\\n  tileId\\n  tileType\\n  title\\n  __typename\\n}\\n\\nfragment modularTileBingAd on ModularFeedTileBingAd {\\n  tileId\\n  bingAd {\\n    ouAdId\\n    adExperimentId\\n    adNetwork\\n    adRequestId\\n    adTileType\\n    clickFeedbackUrl\\n    clickReturnUrl\\n    contentUrl\\n    experimentDataHash\\n    image {\\n      height\\n      url\\n      width\\n      __typename\\n    }\\n    impressionFeedbackUrl\\n    itemName\\n    lowPrice\\n    price\\n    searchId\\n    sellerName\\n    __typename\\n  }\\n  tileType\\n  __typename\\n}\\n\\nfragment modularTileGoogleDisplayAd on ModularFeedTileGoogleDisplayAd {\\n  tileId\\n  googleDisplayAd {\\n    ouAdId\\n    additionalSizes\\n    adExperimentId\\n    adHeight\\n    adNetwork\\n    adPage\\n    adRequestId\\n    adTileType\\n    adWidth\\n    channel\\n    clickFeedbackUrl\\n    clientId\\n    contentUrl\\n    customTargeting {\\n      key\\n      values\\n      __typename\\n    }\\n    displayAdType\\n    errorDrawable {\\n      actionPath\\n      listImage {\\n        height\\n        url\\n        width\\n        __typename\\n      }\\n      __typename\\n    }\\n    experimentDataHash\\n    formatIds\\n    impressionFeedbackUrl\\n    personalizationProperties {\\n      key\\n      values\\n      __typename\\n    }\\n    searchId\\n    searchQuery\\n    templateId\\n    __typename\\n  }\\n  tileType\\n  __typename\\n}\\n\\nfragment modularTileJob on ModularFeedTileJob {\\n  tileId\\n  tileType\\n  job {\\n    address {\\n      city\\n      state\\n      zipcode\\n      __typename\\n    }\\n    companyName\\n    datePosted\\n    image {\\n      height\\n      url\\n      width\\n      __typename\\n    }\\n    industry\\n    jobId\\n    jobListingUrl\\n    pills {\\n      text\\n      type\\n      __typename\\n    }\\n    title\\n    __typename\\n  }\\n  __typename\\n}\\n\\nfragment modularTileEmptyState on ModularFeedTileEmptyState {\\n  tileId\\n  tileType\\n  title\\n  description\\n  iconType\\n  __typename\\n}\\n\\nfragment modularTileListing on ModularFeedTileListing {\\n  tileId\\n  listing {\\n    ...modularListing\\n    __typename\\n  }\\n  tileType\\n  __typename\\n}\\n\\nfragment modularListing on ModularFeedListing {\\n  listingId\\n  conditionText\\n  flags\\n  image {\\n    height\\n    url\\n    width\\n    __typename\\n  }\\n  isFirmPrice\\n  locationName\\n  price\\n  title\\n  vehicleMiles\\n  __typename\\n}\\n\\nfragment modularTileLocalDisplayAd on ModularFeedTileLocalDisplayAd {\\n  tileId\\n  localDisplayAd {\\n    ouAdId\\n    adExperimentId\\n    adNetwork\\n    adRequestId\\n    adTileType\\n    advertiserId\\n    businessName\\n    callToAction\\n    callToActionType\\n    clickFeedbackUrl\\n    contentUrl\\n    experimentDataHash\\n    headline\\n    image {\\n      height\\n      url\\n      width\\n      __typename\\n    }\\n    impressionFeedbackUrl\\n    searchId\\n    __typename\\n  }\\n  tileType\\n  __typename\\n}\\n\\nfragment modularTileSearchAlert on ModularFeedTileSearchAlert {\\n  tileId\\n  tileType\\n  title\\n  __typename\\n}\\n\\nfragment modularTileSellerAd on ModularFeedTileSellerAd {\\n  tileId\\n  listing {\\n    ...modularListing\\n    __typename\\n  }\\n  sellerAd {\\n    ouAdId\\n    adId\\n    adExperimentId\\n    adNetwork\\n    adRequestId\\n    adTileType\\n    clickFeedbackUrl\\n    experimentDataHash\\n    impressionFeedbackUrl\\n    searchId\\n    __typename\\n  }\\n  tileType\\n  __typename\\n}\\n\\nfragment modularGridModule on ModularFeedModuleGrid {\\n  moduleId\\n  collection\\n  formFactor\\n  grid {\\n    actionPath\\n    tiles {\\n      ...modularModuleTileBingAd\\n      ...modularModuleTileGoogleDisplayAd\\n      ...modularModuleTileListing\\n      ...modularModuleTileLocalDisplayAd\\n      ...modularModuleTileSellerAd\\n      __typename\\n    }\\n    __typename\\n  }\\n  moduleType\\n  rank\\n  rowIndex\\n  searchId\\n  subTitle\\n  title\\n  __typename\\n}\\n\\nfragment modularModuleTileBingAd on ModularFeedTileBingAd {\\n  ...modularTileBingAd\\n  moduleId\\n  moduleRank\\n  moduleType\\n  __typename\\n}\\n\\nfragment modularModuleTileGoogleDisplayAd on ModularFeedTileGoogleDisplayAd {\\n  ...modularTileGoogleDisplayAd\\n  moduleId\\n  moduleRank\\n  moduleType\\n  __typename\\n}\\n\\nfragment modularModuleTileListing on ModularFeedTileListing {\\n  ...modularTileListing\\n  moduleId\\n  moduleRank\\n  moduleType\\n  __typename\\n}\\n\\nfragment modularModuleTileLocalDisplayAd on ModularFeedTileLocalDisplayAd {\\n  ...modularTileLocalDisplayAd\\n  moduleId\\n  moduleRank\\n  moduleType\\n  __typename\\n}\\n\\nfragment modularModuleTileSellerAd on ModularFeedTileSellerAd {\\n  ...modularTileSellerAd\\n  moduleId\\n  moduleRank\\n  moduleType\\n  __typename\\n}\\n\\nfragment modularQueryInfo on ModularFeedQueryInfo {\\n  appliedQuery\\n  decisionType\\n  originalQuery\\n  suggestedQuery\\n  __typename\\n}\\n\"}`,
        "method": "POST",
    })
        .then(res => {
            const result = JSON.parse(res);

            const formattedItems = [];
            result.data.modularFeed.looseTiles.forEach(i => {
                if (i.listing) {
                    formattedItems.push(new Product(i.listing.listingId, config.store, i.listing.title, `https://offerup.com/item/detail/${i.listing.listingId}`, i.listing.price, i.listing.image.url, i.listing.locationName))
                }
            })

            resolve(formattedItems)
        })
        .catch(reject)
})

// getProducts(config)

module.exports = getProducts;